<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: ExperimentBuilder</title>
  <script src="/storage.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/en.js"></script>
  <script src="../../blocks/test.js"></script>
  <script src="../../generators/javascript/test.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>
  <h1><a href="https://developers.google.com/blockly/">Blockly</a> &gt;
    <a href="../index.html">Demos</a> &gt; Experiment Builder</h1>

  <p>Project Name: <a href='#' onclick='toggleRenameProject()'><b id="projectName">Untitled</b></a></p>

  <p>
    <button onclick="showCode()">Show JavaScript</button>
    <button onclick="runCode()">Run JavaScript</button>
	<button onclick="saveXml()">Save XML</button>
	<button id="fakeload">Load XML</button>
	<input type="file" id="xmlLoader" style="display: none;"/>
	<script type="text/javascript">
		function loadFile(event) {
			var file = event.target.files[0];
			
			if(file){
				var reader = new FileReader();
				
				reader.onloadend = function(event) {
					var target = event.target;
					
					// 2 == FileReader.DONE
					if (target.readyState == 2) {
						try {
							var xml = Blockly.Xml.textToDom(target.result);
						} catch (e) {
							alert('Error parsing XML:\n' + e);
							return;
						}
						
						var count = Blockly.mainWorkspace.getAllBlocks().length;
						if (count && confirm('Replace existing blocks?\n"Cancel" will merge.')) {
							Blockly.mainWorkspace.clear();
						}
						
						Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
					}
					
					// Reset value of input after loading because Chrome will not fire
					// a 'change' event if the same file is loaded again.
					document.getElementById('xmlLoader').value = '';
				};
				
				var text = reader.readAsText(file);
			}
		}
		
		var loadInput = document.getElementById('xmlLoader');
		loadInput.addEventListener('change', loadFile, false);
		document.getElementById('fakeload').onclick = function() { loadInput.click(); };
	</script>
</div>
  </p>

  <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>

  <xml id="toolbox" style="display: none">
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
    </category>
	<category name="Test">
      <block type="test_apiCall"></block>
	  <block type="test_wait"></block>
    </category>
  </xml>

  <xml id="startBlocks" style="display: none">
    <block type="controls_if" inline="false" x="20" y="20">
      <mutation else="1"></mutation>
      <value name="IF0">
        <block type="logic_compare" inline="true">
          <field name="OP">EQ</field>
          <value name="A">
            <block type="math_arithmetic" inline="true">
              <field name="OP">MULTIPLY</field>
              <value name="A">
                <block type="math_number">
                  <field name="NUM">6</field>
                </block>
              </value>
              <value name="B">
                <block type="math_number">
                  <field name="NUM">7</field>
                </block>
              </value>
            </block>
          </value>
          <value name="B">
            <block type="math_number">
              <field name="NUM">42</field>
            </block>
          </value>
        </block>
      </value>
      <statement name="DO0">
        <block type="text_print" inline="false">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">Don't panic</field>
            </block>
          </value>
        </block>
      </statement>
      <statement name="ELSE">
        <block type="text_print" inline="false">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">Panic</field>
            </block>
          </value>
        </block>
      </statement>
			<next><block type="test_wait" id="15" inline="false"><value name="DURATION"><block type="math_number" id="19"><field name="NUM">5</field></block></value></block></next>
    </next>
    </block>
  </xml>

  <script>
    Blockly.inject(document.getElementById('blocklyDiv'),
        {toolbox: document.getElementById('toolbox')});
    Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,
        document.getElementById('startBlocks'));

	document.getElementById('projectName').innerHTML = 'testProject';	
	// todo - test
	// Start Polling functions here
	//sendGetProjects();
	//sendGetStatus();
	
	// todo - test	
	function sendGetProjects() {
		var request = new XMLHttpRequest();
		request.open("get", "http://localhost:1337/ExperimentBuilder/GetProjects?format=json");
		request.onreadystatechange = function(e) {
			if(request.readyState != 4) {
				return;
			}
			// todo do something with the response
			var responseText = request.responseText;
			
			// Trigger the next poll
			setTimeout(sendGetProjects, 3000);
		};
        request.send();
	}
	
	// todo - test
	function sendGetStatus() {
		var request = new XMLHttpRequest();
		request.open("get", "http://localhost:1337/ExperimentBuilder/Status?format=json");
		request.onreadystatechange = function(e) {
			if(request.readyState != 4) {
				return;
			}
			// todo do something with the response
			var responseText = request.responseText;
			
			// Trigger the next poll
			setTimeout(sendGetStatus, 3000);
		};
        request.send();
	}
	
    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null; 
      var code = Blockly.JavaScript.workspaceToCode();
      alert(code);
    }

    function runCode() {
      // Generate JavaScript code and run it.
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP = 
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode();
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }
	
	// todo - test
	function loadXml() {
		// Load Xml from file
		var projectName = "testName";
		
		var request = new XMLHttpRequest();
		request.open("get", "http://localhost:1337/ExperimentBuilder/Load/" + projectName + "?format=json");
		request.onreadystatechange = function(e) {
			if(request.readyState != 4) {
				return;
			}
			
			try {
				var xml = Blockly.Xml.textToDom(request.responseText);
			} catch (e) {
				alert('Error parsing XML:\n' + e);
				return;
			}
						
			var count = Blockly.mainWorkspace.getAllBlocks().length;
			if (count && confirm('Replace existing blocks?\n"Cancel" will merge.')) {
				Blockly.mainWorkspace.clear();
			}
			
			Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
			
			//Update project name with the new project name
			document.getElementById('projectName').innerHTML = projectName;	
		};
        request.send();
	}
	
	function saveXml() {
		// Save Xml to a file from startBlocks
		var xml = Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());
		var data = Blockly.Xml.domToText(xml);
		
		toggleRenameProject();
		var projectName = document.getElementById('projectName').innerHTML;
		
		var fd = new FormData();
		fd.append("XmlData", data);
		fd.append("ProjectName", projectName);
		
		var request = new XMLHttpRequest();
		request.open("post", "http://localhost:1337/ExperimentBuilder/Save?format=json");
		request.onreadystatechange = function(e) {
			if(request.readyState != 4) {
				return;
			}
			// todo tell the user the name of the project saved from response text
			// todo tell the user save failed if it does
			var responseText = request.responseText;
			alert("Save Complete!");
		};
        request.send(fd);
	}
  </script>

	<div id="renameProject">
		<div>
			<p>
				Project Name: 
				<input name="name" id="newName" size="30" type="text" value="test"/>
			</p>
			<button onclick="renameAndToggle()">OK</button>
			<button onclick="toggleRenameProject()">Cancel</button>
		</div>
	</div>
	<script>
	function toggleRenameProject() {
		var currentName = document.getElementById('projectName').innerHTML;
		document.getElementById('newName').value = currentName;
		
		el = document.getElementById("renameProject");
		el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
	}
	
	function renameAndToggle() {
		var newName = document.getElementById('newName').value;
		document.getElementById('projectName').innerHTML = newName;
		
		el = document.getElementById("renameProject");
		el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
	}
	</script>
	<style>
	#renameProject {
     visibility: hidden;
     position: absolute;
     left: 0px;
     top: 0px;
     width:100%;
     height:100%;
     text-align:center;
     z-index: 1000;
	}
	
	#renameProject div {
     width:300px;
     margin: 100px auto;
     background-color: #fff;
     border:2px solid #000;
     padding:15px;
     text-align:center;
	}
</style>
</body>
</html>
